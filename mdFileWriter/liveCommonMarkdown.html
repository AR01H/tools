<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>We1 | Markdown Editor</title>
  <link rel="icon" href="../logo.png" type="image/x-icon">
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/5.3.0/darkly/bootstrap.min.css"/>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"/>
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <style>
    :root {
      --sidebar-width: 280px;
      --toolbar-height: 60px;
      --accent-color: #007bff;
      --dark-bg: #1a1a1a;
      --darker-bg: #0d1117;
      --light-border: #30363d;
      --text-muted: #ffffff;
    }
    
    * { box-sizing: border-box; }
    
    body {
      margin: 0;
      display: flex;
      height: 100vh;
      font-family: 'Segoe UI', system-ui, sans-serif;
      background: var(--dark-bg);
      color: #f0f6fc;
      overflow: hidden;
    }
    
    /* Sidebar Styling */
    #sidebar {
      width: var(--sidebar-width);
      background: var(--darker-bg);
      border-right: 1px solid var(--light-border);
      display: flex;
      flex-direction: column;
      box-shadow: 2px 0 10px rgba(0,0,0,0.3);
    }
    
    .sidebar-header {
      padding: 1rem;
      border-bottom: 1px solid var(--light-border);
      background: linear-gradient(135deg, #007bff, #0056b3);
    }
    
    .sidebar-header h4 {
      margin: 0;
      color: white;
      font-weight: 600;
      font-size: 1.1rem;
    }
    
    .sidebar-actions {
      padding: 1rem;
      border-bottom: 1px solid var(--light-border);
    }
    
    .file-stats {
      padding: 0.5rem 1rem;
      font-size: 0.8rem;
      color: var(--text-muted);
      border-bottom: 1px solid var(--light-border);
    }
    
    #fileList {
      flex: 1;
      overflow-y: auto;
      padding: 0.5rem 0;
    }
    
    .file-item {
      padding: 0.75rem 1rem;
      cursor: pointer;
      border-left: 3px solid transparent;
      transition: all 0.2s ease;
      display: flex;
      justify-content: space-between;
      align-items: center;
      position: relative;
    }
    
    .file-item:hover {
      background: rgba(255,255,255,0.05);
    }
    
    .file-item.active {
      background: rgba(0,123,255,0.15);
      border-left-color: var(--accent-color);
      color: #58a6ff;
    }
    
    .file-actions {
      opacity: 0;
      transition: opacity 0.2s;
    }
    
    .file-item:hover .file-actions {
      opacity: 1;
    }
    
    .file-actions button {
      background: none;
      border: none;
      color: var(--text-muted);
      padding: 2px 6px;
      margin-left: 4px;
      border-radius: 3px;
      font-size: 0.8rem;
      cursor: pointer;
    }
    
    .file-actions button:hover {
      background: rgba(255,255,255,0.1);
      color: white;
    }
    
    /* Main Area */
    #main {
      flex: 1;
      display: flex;
      flex-direction: column;
      background: var(--dark-bg);
    }
    
    /* Enhanced Toolbar */
    #toolbar {
      height: var(--toolbar-height);
      padding: 0.5rem 1rem;
      background: var(--darker-bg);
      border-bottom: 1px solid var(--light-border);
      display: flex;
      align-items: center;
      flex-wrap: wrap;
      gap: 6px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.2);
    }
    
    .toolbar-group {
      display: flex;
      gap: 4px;
      padding-right: 8px;
      border-right: 1px solid var(--light-border);
      margin-right: 8px;
    }
    
    .toolbar-group:last-child {
      border-right: none;
      margin-right: 0;
    }
    
    .btn-toolbar {
      padding: 6px 12px;
      font-size: 0.85rem;
      border: 1px solid var(--light-border);
      background: rgba(255,255,255,0.05);
      color: var(--text-muted);
      border-radius: 6px;
      transition: all 0.2s ease;
      cursor: pointer;
    }
    
    .btn-toolbar:hover {
      background: rgba(255,255,255,0.1);
      border-color: var(--accent-color);
      transform: translateY(-1px);
    }
    
    /* Editor Container */
    #editor-container {
      flex: 1;
      display: flex;
      overflow: hidden;
      position: relative;
    }
    
    .editor-panel {
      flex: 1;
      display: flex;
      flex-direction: column;
      min-width: 0;
    }
    
    .panel-header {
      padding: 0.5rem 1rem;
      background: var(--darker-bg);
      border-bottom: 1px solid var(--light-border);
      font-size: 0.9rem;
      font-weight: 500;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .panel-controls {
      display: flex;
      gap: 8px;
    }
    
    .panel-btn {
      background: none;
      border: 1px solid var(--light-border);
      color: var(--text-muted);
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 0.8rem;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .panel-btn:hover, .panel-btn.active {
      background: var(--accent-color);
      color: white;
      border-color: var(--accent-color);
    }
    
    #editor {
      border-right: 1px solid var(--light-border);
    }
    
    #editor textarea {
      width: 100%;
      height: 100%;
      border: none;
      resize: none;
      outline: none;
      font-family: 'JetBrains Mono', 'Fira Code', monospace;
      font-size: 14px;
      line-height: 1.6;
      padding: 1rem;
      background: var(--dark-bg);
      color: #f0f6fc;
      tab-size: 2;
    }
    
    #editor textarea::selection {
      background: rgba(0,123,255,0.3);
    }
    
    #preview {
      background: var(--dark-bg);
      padding: 1rem;
      overflow-y: auto;
      line-height: 1.6;
    }
    
    /* Preview Content Styling */
    #preview h1, #preview h2, #preview h3, #preview h4, #preview h5, #preview h6 {
      color: #58a6ff;
      border-bottom: 1px solid var(--light-border);
      padding-bottom: 0.3rem;
      margin-top: 1.5rem;
      margin-bottom: 1rem;
    }
    
    #preview blockquote {
      border-left: 4px solid var(--accent-color);
      padding-left: 1rem;
      margin: 1rem 0;
      background: rgba(0,123,255,0.1);
      padding: 0.5rem 1rem;
      border-radius: 0 6px 6px 0;
    }
    
    #preview code {
      background: var(--darker-bg);
      padding: 2px 6px;
      border-radius: 4px;
      font-family: 'JetBrains Mono', monospace;
      color: #ff7b72;
    }
    
    #preview pre {
      background: var(--darker-bg);
      border: 1px solid var(--light-border);
      border-radius: 8px;
      padding: 1rem;
      overflow-x: auto;
    }
    
    #preview pre code {
      background: none;
      padding: 0;
      color: var(--text-muted);
    }
    
    #preview table {
      border-collapse: collapse;
      width: 100%;
      margin: 1rem 0;
      border: 1px solid var(--light-border);
      border-radius: 8px;
      overflow: hidden;
    }
    
    #preview th, #preview td {
      border: 1px solid var(--light-border);
      padding: 0.75rem;
      text-align: left;
    }
    
    #preview th {
      background: var(--darker-bg);
      font-weight: 600;
    }
    
    #preview tr:nth-child(even) {
      background: rgba(255,255,255,0.02);
    }
    
    /* Search Bar */
    .search-container {
      position: relative;
    }
    
    .search-input {
      background: var(--darker-bg);
      border: 1px solid var(--light-border);
      color: #f0f6fc;
      padding: 6px 12px;
      border-radius: 6px;
      width: 200px;
      font-size: 0.9rem;
    }
    
    .search-input:focus {
      outline: none;
      border-color: var(--accent-color);
      box-shadow: 0 0 0 2px rgba(0,123,255,0.2);
    }
    
    /* Word Count & Status */
    .status-bar {
      padding: 0.5rem 1rem;
      background: var(--darker-bg);
      border-top: 1px solid var(--light-border);
      font-size: 0.8rem;
      color: var(--text-muted);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    /* Responsive Design */
    @media (max-width: 768px) {
      :root { --sidebar-width: 0px; }
      #sidebar { transform: translateX(-100%); position: fixed; z-index: 1000; height: 100vh; }
      #sidebar.show { transform: translateX(0); }
      .mobile-menu-btn { display: block !important; }
    }
    
    .mobile-menu-btn {
      display: none;
      background: var(--accent-color);
      border: none;
      color: white;
      padding: 8px 12px;
      border-radius: 6px;
      cursor: pointer;
    }
    
    /* Light Mode */
    .light-mode {
      --dark-bg: #ffffff;
      --darker-bg: #f6f8fa;
      --light-border: #d1d9e0;
      --text-muted: #656d76;
      color: #1f2328;
    }
    
    .light-mode #editor textarea {
      background: #ffffff;
      color: #1f2328;
    }
    
    .light-mode #preview h1, .light-mode #preview h2, .light-mode #preview h3,
    .light-mode #preview h4, .light-mode #preview h5, .light-mode #preview h6 {
      color: #0969da;
    }
    
    /* Custom Scrollbar */
    ::-webkit-scrollbar { width: 8px; height: 8px; }
    ::-webkit-scrollbar-track { background: var(--darker-bg); }
    ::-webkit-scrollbar-thumb { background: var(--light-border); border-radius: 4px; }
    ::-webkit-scrollbar-thumb:hover { background: var(--text-muted); }
  </style>
</head>
<body>
  <div id="sidebar">
    <div class="sidebar-header">
      <span class="navbar-brand fw-bold" style="display: flex;align-items: center;gap: 10px;">
        <img src="../logo.png" width="30" style="background: #ff000082;padding: 1px;border-radius: 5px;" />
        <strong>Markdown</strong>
      </span>
    </div>
    
    <div class="sidebar-actions">
      <button class="btn btn-primary btn-sm w-100 mb-2" onclick="newFile()">
        <i class="fas fa-plus"></i> New File
      </button>
      <div class="row g-1">
        <div class="col-6">
          <button class="btn btn-secondary btn-sm w-100" onclick="importFile()">
            <i class="fas fa-upload"></i> Import
          </button>
        </div>
        <div class="col-6">
          <button class="btn btn-outline-secondary btn-sm w-100" onclick="toggleTheme()">
            <i class="fas fa-adjust"></i> Theme
          </button>
        </div>
      </div>
    </div>
    
    <div class="file-stats">
      <span id="fileCount">0 files</span> • 
      <span id="wordCount">0 words</span>
    </div>
    
    <ul id="fileList" class="list-unstyled mb-0"></ul>
  </div>
  
  <div id="main">
    <div id="toolbar">
      <button class="mobile-menu-btn" onclick="toggleSidebar()">
        <i class="fas fa-bars"></i>
      </button>
      
      <div class="toolbar-group">
        <button class="btn-toolbar" onclick="insertSym('**','**')" title="Bold">
          <i class="fas fa-bold"></i>
        </button>
        <button class="btn-toolbar" onclick="insertSym('_','_')" title="Italic">
          <i class="fas fa-italic"></i>
        </button>
        <button class="btn-toolbar" onclick="insertSym('~~','~~')" title="Strikethrough">
          <i class="fas fa-strikethrough"></i>
        </button>
        <button class="btn-toolbar" onclick="insertSym('`','`')" title="Highlight">
          <i class="fas fa-highlighter"></i>
        </button>
      </div>
      
      <div class="toolbar-group">
        <button class="btn-toolbar" onclick="insertSym('# ','')">H1</button>
        <button class="btn-toolbar" onclick="insertSym('## ','')">H2</button>
        <button class="btn-toolbar" onclick="insertSym('### ','')">H3</button>
        <button class="btn-toolbar" onclick="insertSym('#### ','')">H4</button>
        <button class="btn-toolbar" onclick="insertSym('##### ','')">H5</button>
        <button class="btn-toolbar" onclick="insertSym('###### ','')">H6</button>
      </div>
      
      <div class="toolbar-group">
        <button class="btn-toolbar" onclick="insertSym('> ','')">
          <i class="fas fa-quote-left"></i>
        </button>
        <button class="btn-toolbar" onclick="insertSym('- ','')">
          <i class="fas fa-list-ul"></i>
        </button>
        <button class="btn-toolbar" onclick="insertSym('1. ','')">
          <i class="fas fa-list-ol"></i>
        </button>
        <button class="btn-toolbar" onclick="insertSym('- [ ] ','')">
          <i class="fas fa-tasks"></i>
        </button>
      </div>
      
      <div class="toolbar-group">
        <button class="btn-toolbar" onclick="insertSym('```\n','\n```')">
          <i class="fas fa-file-code"></i>
        </button>
        <button class="btn-toolbar" onclick="insertLink()">
          <i class="fas fa-link"></i>
        </button>
        <button class="btn-toolbar" onclick="insertImage()">
          <i class="fas fa-image"></i>
        </button>
      </div>
      
      <div class="toolbar-group">
        <button class="btn-toolbar" onclick="insertTable()">
          <i class="fas fa-table"></i>
        </button>
        <button class="btn-toolbar" onclick="insertSym('--- ','')">
          <i class="fas fa-minus"></i>
        </button>
      </div>
      
      <div class="toolbar-group">
        <button class="btn-toolbar" onclick="saveAll()" title="Save All">
          <i class="fas fa-save"></i>
        </button>
        <button class="btn-toolbar" onclick="exportMD()" title="Export MD">
          <i class="fas fa-download"></i> .md
        </button>
        <button class="btn-toolbar" onclick="exportHTML()" title="Export HTML">
          <i class="fas fa-download"></i> .html
        </button>
        <button class="btn-toolbar" onclick="copyHTML()" title="Copy HTML">
          <i class="fas fa-copy"></i>
        </button>
      </div>
      
      <!-- <div class="search-container">
        <input type="text" class="search-input" placeholder="Search & replace..." 
               oninput="searchContent(this.value)" onkeypress="handleSearchKey(event)"/>
      </div> -->
    </div>
    
    <div id="editor-container">
      <div class="editor-panel" id="editor">
        <div class="panel-header">
          <span><i class="fas fa-edit"></i> Editor</span>
          <div class="panel-controls">
            <button class="panel-btn" onclick="toggleWrap()" title="Word Wrap">
              <i class="fas fa-text-width"></i>
            </button>
            <button class="panel-btn" onclick="clearThis()" title="Clear">
              <i class="fas fa-trash"></i>
            </button>
          </div>
        </div>
        <textarea id="markdown" placeholder="Start writing your markdown here..."></textarea>
      </div>
      
      <div class="editor-panel" id="preview">
        <div class="panel-header">
          <span><i class="fas fa-eye"></i> Preview</span>
          <div class="panel-controls">
            <button class="panel-btn active" onclick="togglePreviewMode('preview')" id="preview-btn">
              Preview
            </button>
            <button class="panel-btn" onclick="togglePreviewMode('split')" id="split-btn">
              Split
            </button>
            <button class="panel-btn" onclick="togglePreviewMode('editor')" id="editor-btn">
              Editor
            </button>
          </div>
        </div>
        <div id="preview-content"></div>
      </div>
    </div>
    
    <div class="status-bar">
      <div class="status-left">
        <span id="currentFileName">Untitled</span> •
        <span id="modifiedStatus">Saved</span>
      </div>
      <div class="status-right">
        <span id="lineCount">1 line</span> •
        <span id="charCount">0 characters</span> •
        <span id="liveWordCount">0 words</span>
      </div>
    </div>
  </div>

  <input type="file" id="fileInput" accept=".md,.txt" style="display:none" onchange="handleFileImport(event)"/>

<script>
  const STORAGE = 'pmd_files_v2';
  let files = JSON.parse(localStorage.getItem(STORAGE) || '{}');
  let current = '';
  let searchQuery = '';
  let currentMode = 'split';
  let isModified = false;

  // Initialize markdown renderer
  marked.setOptions({
    breaks: true,
    gfm: true,
    headerIds: true,
    mangle: false
  });

  // Initialize app
  window.onload = function() {
    // Load theme
    if (localStorage.getItem('theme') === 'light') {
      document.body.classList.add('light-mode');
    }
    
    // Load files or create default
    if (Object.keys(files).length) {
      current = Object.keys(files)[0];
      refreshSidebar();
      loadFile();
    } else {
      newFile();
    }
    
    // Setup auto-save
    setInterval(autoSave, 5000);
    
    // Setup editor events
    const textarea = document.getElementById('markdown');
    textarea.addEventListener('input', handleEditorChange);
    textarea.addEventListener('scroll', syncScroll);
    
    // Keyboard shortcuts
    document.addEventListener('keydown', handleKeyboardShortcuts);
  };

  function refreshSidebar() {
    const list = document.getElementById('fileList');
    list.innerHTML = '';
    
    const fileNames = Object.keys(files).sort();
    
    for (let name of fileNames) {
      const li = document.createElement('li');
      li.className = 'file-item' + (name === current ? ' active' : '');
      
      li.innerHTML = '<span class="file-name" onclick="switchFile(\'' + name + '\')">' + name + '</span>' +
        '<div class="file-actions">' +
          '<button onclick="renameFile(\'' + name + '\')" title="Rename">' +
            '<i class="fas fa-edit"></i>' +
          '</button>' +
          '<button onclick="duplicateFile(\'' + name + '\')" title="Duplicate">' +
            '<i class="fas fa-copy"></i>' +
          '</button>' +
          '<button onclick="deleteFile(\'' + name + '\')" title="Delete">' +
            '<i class="fas fa-trash"></i>' +
          '</button>' +
        '</div>';
      
      list.append(li);
    }
    
    updateFileStats();
  }

  function updateFileStats() {
    const fileCount = Object.keys(files).length;
    document.getElementById('fileCount').textContent = fileCount + ' file' + (fileCount !== 1 ? 's' : '');
    
    const content = files[current] || '';
    const wordCount = content.trim() ? content.trim().split(/\s+/).length : 0;
    document.getElementById('wordCount').textContent = wordCount + ' word' + (wordCount !== 1 ? 's' : '');
  }

  function newFile() {
    const name = prompt('File name:') || ('untitled_' + Date.now());
    if (files[name]) {
      alert('File already exists!');
      return;
    }
    files[name] = '';
    current = name;
    refreshSidebar();
    loadFile();
    updateStatus();
  }

  function switchFile(name) {
    saveCurrent();
    current = name;
    refreshSidebar();
    loadFile();
    updateStatus();
  }

  function renameFile(oldName) {
    const newName = prompt('New name:', oldName);
    if (!newName || newName === oldName) return;
    if (files[newName]) {
      alert('File already exists!');
      return;
    }
    
    files[newName] = files[oldName];
    delete files[oldName];
    if (current === oldName) current = newName;
    refreshSidebar();
    updateStatus();
  }

  function duplicateFile(name) {
    const newName = prompt('New name:', name + '_copy');
    if (!newName || files[newName]) {
      alert('Invalid name or file already exists!');
      return;
    }
    files[newName] = files[name];
    refreshSidebar();
  }

  function deleteFile(name) {
    if (!confirm('Delete "' + name + '"?')) return;
    delete files[name];
    
    if (current === name) {
      const remaining = Object.keys(files);
      if (remaining.length > 0) {
        current = remaining[0];
        loadFile();
      } else {
        newFile();
        return;
      }
    }
    refreshSidebar();
    updateStatus();
  }

  function saveCurrent() {
    if (current) {
      files[current] = document.getElementById('markdown').value;
      isModified = false;
      updateStatus();
    }
  }

  function loadFile() {
    const content = files[current] || '';
    document.getElementById('markdown').value = content;
    updatePreview();
    updateStatus();
    updateStats();
  }

  function saveAll() {
    saveCurrent();
    localStorage.setItem(STORAGE, JSON.stringify(files));
    showToast('All files saved!', 'success');
  }

  function autoSave() {
    if (isModified) {
      saveCurrent();
      localStorage.setItem(STORAGE, JSON.stringify(files));
    }
  }

  function handleEditorChange() {
    isModified = true;
    updatePreview();
    updateStatus();
    updateStats();
  }

  function updateStatus() {
    document.getElementById('currentFileName').textContent = current || 'Untitled';
    document.getElementById('modifiedStatus').textContent = isModified ? 'Modified' : 'Saved';
  }

  function updateStats() {
    const content = document.getElementById('markdown').value;
    const lines = content.split('\n').length;
    const chars = content.length;
    const words = content.trim() ? content.trim().split(/\s+/).length : 0;
    
    document.getElementById('lineCount').textContent = lines + ' line' + (lines !== 1 ? 's' : '');
    document.getElementById('charCount').textContent = chars + ' character' + (chars !== 1 ? 's' : '');
    document.getElementById('liveWordCount').textContent = words + ' word' + (words !== 1 ? 's' : '');
    
    updateFileStats();
  }

  function insertSym(start, end) {
    const textarea = document.getElementById('markdown');
    const selStart = textarea.selectionStart;
    const selEnd = textarea.selectionEnd;
    const value = textarea.value;
    const selected = value.slice(selStart, selEnd);
    
    const newText = start + selected + end;
    textarea.value = value.slice(0, selStart) + newText + value.slice(selEnd);
    
    // Set cursor position
    const newPos = selStart + start.length + selected.length;
    textarea.setSelectionRange(newPos, newPos);
    textarea.focus();
    
    handleEditorChange();
  }

  function insertTable() {
    const rows = prompt('Number of rows:', '3') || '3';
    const cols = prompt('Number of columns:', '3') || '3';
    
    let table = '';
    
    // Header row
    table += '|';
    for (let i = 0; i < parseInt(cols); i++) {
      table += ' Header ' + (i + 1) + ' |';
    }
    table += '\n';
    
    // Separator row
    table += '|';
    for (let i = 0; i < parseInt(cols); i++) {
      table += ' --- |';
    }
    table += '\n';
    
    // Data rows
    for (let row = 0; row < parseInt(rows) - 1; row++) {
      table += '|';
      for (let col = 0; col < parseInt(cols); col++) {
        table += ' Cell ' + (row + 1) + '-' + (col + 1) + ' |';
      }
      table += '\n';
    }
    
    insertSym(table, '');
  }

  function insertLink() {
    const text = prompt('Link text:', 'Link');
    const url = prompt('URL:', 'https://');
    if (text && url) {
      insertSym('[' + text + '](' + url + ')', '');
    }
  }

  function insertImage() {
    const alt = prompt('Alt text:', 'Image');
    const url = prompt('Image URL:', 'https://');
    if (alt && url) {
      insertSym('![' + alt + '](' + url + ')', '');
    }
  }

  function updatePreview() {
    const content = document.getElementById('markdown').value;
    document.getElementById('preview-content').innerHTML = marked.parse(content);
    syncScroll();
  }

  function syncScroll() {
    const editor = document.querySelector('#editor textarea');
    const preview = document.getElementById('preview-content');
    
    if (editor && preview) {
      const scrollRatio = editor.scrollTop / (editor.scrollHeight - editor.clientHeight);
      preview.scrollTop = scrollRatio * (preview.scrollHeight - preview.clientHeight);
    }
  }

  function togglePreviewMode(mode) {
    currentMode = mode;
    const editor = document.getElementById('editor');
    const preview = document.getElementById('preview');
    
    // Reset classes
    editor.style.display = 'flex';
    preview.style.display = 'flex';
    
    // Update button states
    document.querySelectorAll('.panel-btn').forEach(function(btn) { 
      btn.classList.remove('active'); 
    });
    
    switch (mode) {
      case 'editor':
        preview.style.display = 'none';
        document.getElementById('editor-btn').classList.add('active');
        break;
      case 'preview':
        editor.style.display = 'none';
        document.getElementById('preview-btn').classList.add('active');
        break;
      case 'split':
        document.getElementById('split-btn').classList.add('active');
        break;
    }
  }

  function toggleTheme() {
    document.body.classList.toggle('light-mode');
    const isLight = document.body.classList.contains('light-mode');
    localStorage.setItem('theme', isLight ? 'light' : 'dark');
    showToast('Switched to ' + (isLight ? 'light' : 'dark') + ' mode', 'info');
  }

  function importFile() {
    document.getElementById('fileInput').click();
  }

  function handleFileImport(event) {
    const file = event.target.files[0];
    if (!file) return;
    
    const reader = new FileReader();
    reader.onload = function(e) {
      const name = file.name.replace(/\.[^/.]+$/, "") || 'imported_file';
      const uniqueName = getUniqueName(name);
      files[uniqueName] = e.target.result;
      current = uniqueName;
      refreshSidebar();
      loadFile();
      showToast('Imported "' + uniqueName + '"', 'success');
    };
    reader.readAsText(file);
  }

  function getUniqueName(baseName) {
    if (!files[baseName]) return baseName;
    
    let counter = 1;
    let newName = baseName + '_' + counter;
    while (files[newName]) {
      counter++;
      newName = baseName + '_' + counter;
    }
    return newName;
  }

  function exportMD() {
    saveCurrent();
    const content = files[current] || '';
    const blob = new Blob([content], { type: 'text/markdown' });
    downloadBlob(blob, current + '.md');
    showToast('Markdown exported!', 'success');
  }

  function exportHTML() {
    saveCurrent();
    const content = files[current] || '';

    const html = `
    <!DOCTYPE html>
    <html lang="en">
    <head>
      <meta charset="UTF-8">
      <meta name="viewport" content="width=device-width, initial-scale=1.0">
      <title>${current}</title>
      <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
      <style>
        /* General layout */
        body {
          font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
          margin: 0 auto;
          padding: 1rem 3rem;
          line-height: 1.7;
          background: #f9f9f9;
          color: #333;
        }

        h1, h2, h3, h4, h5, h6 {
          font-weight: 700;
          margin-top: 2rem;
          margin-bottom: 1rem;
          color: #111;
        }

        p {
          margin-bottom: 1.25rem;
        }

        a {
          color: #0070f3;
          text-decoration: none;
        }
        a:hover {
          text-decoration: underline;
        }

        /* Code and pre blocks */
        code {
          background: #caea1a30;
          padding: 2px 6px;
          border-radius: 4px;
          font-family: 'Courier New', Courier, monospace;
          font-size: 0.95em;
        }

        pre {
          background: #2d2d2d;
          color: #f8f8f2;
          padding: 1rem 1.2rem;
          border-radius: 8px;
          overflow-x: auto;
          font-family: 'Courier New', monospace;
          font-size: 0.95em;
        }

        blockquote {
          border-left: 4px solid #0070f3;
          background: #f0f8ff;
          padding: 1rem 1.25rem;
          margin: 1.5rem 0;
          border-radius: 6px;
        }

        hr {
          border: none;
          border-top: 1px solid #ddd;
          margin: 2rem 0;
        }

        /* Tables */
        table {
          border-collapse: collapse;
          width: 100%;
          margin-bottom: 2rem;
        }
        th, td {
          border: 1px solid #ddd;
          padding: 0.75rem 1rem;
          text-align: left;
        }
        th {
          background: #0070f3;
          color: white;
        }

        /* Images */
        img {
          max-width: 100%;
          border-radius: 8px;
        }

        /* Lists */
        ul, ol {
          margin: 1rem 0 1rem 1.5rem;
        }
      </style>
    </head>
    <body>
      ${marked.parse(content)}
    </body>
    </html>
    `;

    const blob = new Blob([html], { type: 'text/html' });
    downloadBlob(blob, current + '.html');
    showToast('HTML exported!', 'success');
  }


  function copyHTML() {
    const content = document.getElementById('markdown').value;
    const html = marked.parse(content);
    navigator.clipboard.writeText(html).then(function() {
      showToast('HTML copied to clipboard!', 'success');
    }).catch(function() {
      showToast('Failed to copy HTML', 'error');
    });
  }

  function downloadBlob(blob, filename) {
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
  }

  function searchContent(query) {
    searchQuery = query.toLowerCase();
    const content = document.getElementById('markdown').value;
    
    if (!query) return;
    
    const index = content.toLowerCase().indexOf(searchQuery);
    if (index >= 0) {
      const textarea = document.getElementById('markdown');
      textarea.focus();
      textarea.setSelectionRange(index, index + query.length);
    }
  }

  function handleSearchKey(event) {
    if (event.key === 'Enter') {
      const query = event.target.value;
      if (event.shiftKey) {
        searchBackwards(query);
      } else {
        searchForwards(query);
      }
    }
  }

  function searchForwards(query) {
    const textarea = document.getElementById('markdown');
    const content = textarea.value.toLowerCase();
    const currentPos = textarea.selectionEnd;
    const index = content.indexOf(query.toLowerCase(), currentPos);
    
    if (index >= 0) {
      textarea.setSelectionRange(index, index + query.length);
    } else {
      const wrapIndex = content.indexOf(query.toLowerCase(), 0);
      if (wrapIndex >= 0) {
        textarea.setSelectionRange(wrapIndex, wrapIndex + query.length);
      }
    }
  }

  function searchBackwards(query) {
    const textarea = document.getElementById('markdown');
    const content = textarea.value.toLowerCase();
    const currentPos = textarea.selectionStart - 1;
    const index = content.lastIndexOf(query.toLowerCase(), currentPos);
    
    if (index >= 0) {
      textarea.setSelectionRange(index, index + query.length);
    } else {
      const wrapIndex = content.lastIndexOf(query.toLowerCase());
      if (wrapIndex >= 0) {
        textarea.setSelectionRange(wrapIndex, wrapIndex + query.length);
      }
    }
  }

  function toggleWrap() {
    const textarea = document.getElementById('markdown');
    if (textarea.style.whiteSpace === 'pre') {
      textarea.style.whiteSpace = 'pre-wrap';
      showToast('Word wrap enabled', 'info');
    } else {
      textarea.style.whiteSpace = 'pre';
      showToast('Word wrap disabled', 'info');
    }
  }

  function clearThis() {
    if (confirm('Clear current content?')) {
      document.getElementById('markdown').value = '';
      handleEditorChange();
    }
  }

  function toggleSidebar() {
    document.getElementById('sidebar').classList.toggle('show');
  }

  function handleKeyboardShortcuts(event) {
    if (event.ctrlKey || event.metaKey) {
      switch (event.key) {
        case 's':
          event.preventDefault();
          saveAll();
          break;
        case 'n':
          event.preventDefault();
          newFile();
          break;
        case 'b':
          event.preventDefault();
          insertSym('**', '**');
          break;
        case 'i':
          event.preventDefault();
          insertSym('_', '_');
          break;
        case 'k':
          event.preventDefault();
          insertLink();
          break;
        case 'e':
          event.preventDefault();
          exportMD();
          break;
        case '1':
          event.preventDefault();
          insertSym('# ', '');
          break;
        case '2':
          event.preventDefault();
          insertSym('## ', '');
          break;
        case '3':
          event.preventDefault();
          insertSym('### ', '');
          break;
      }
    }
    
    if (event.key === 'Escape') {
      document.getElementById('sidebar').classList.remove('show');
    }
  }

  function showToast(message, type) {
    type = type || 'info';
    const toast = document.createElement('div');
    toast.className = 'toast toast-' + type;
    toast.style.cssText = 'position: fixed; top: 20px; right: 20px; background: ' + 
      (type === 'success' ? '#28a745' : type === 'error' ? '#dc3545' : '#007bff') + 
      '; color: white; padding: 12px 20px; border-radius: 6px; box-shadow: 0 4px 12px rgba(0,0,0,0.3); z-index: 10000; transform: translateX(100%); transition: transform 0.3s ease; font-size: 0.9rem; max-width: 300px;';
    toast.textContent = message;
    
    document.body.appendChild(toast);
    
    setTimeout(function() {
      toast.style.transform = 'translateX(0)';
    }, 100);
    
    setTimeout(function() {
      toast.style.transform = 'translateX(100%)';
      setTimeout(function() {
        if (toast.parentNode) {
          toast.parentNode.removeChild(toast);
        }
      }, 300);
    }, 3000);
  }

  // Prevent data loss on page unload
  window.addEventListener('beforeunload', function(event) {
    if (isModified) {
      event.preventDefault();
      event.returnValue = 'You have unsaved changes. Are you sure you want to leave?';
      return event.returnValue;
    }
  });

  // Handle paste events for images
  document.getElementById('markdown').addEventListener('paste', function(event) {
    const items = event.clipboardData.items;
    for (let i = 0; i < items.length; i++) {
      const item = items[i];
      if (item.type.indexOf('image') !== -1) {
        event.preventDefault();
        const file = item.getAsFile();
        const reader = new FileReader();
        reader.onload = function(e) {
          const dataUrl = e.target.result;
          insertSym('![Pasted Image](' + dataUrl + ')', '');
          showToast('Image pasted from clipboard!', 'success');
        };
        reader.readAsDataURL(file);
        break;
      }
    }
  });

  // Auto-save on visibility change
  document.addEventListener('visibilitychange', function() {
    if (document.hidden && isModified) {
      autoSave();
    }
  });
  </script>
</body>
</html>
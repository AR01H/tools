<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Azure Ticket Test Manager - Enhanced</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    
    <style>
        :root {
            --azure-blue: #0078d4;
            --azure-dark: #106ebe;
            --success-green: #107c10;
            --warning-yellow: #ffb900;
            --danger-red: #e81123;
        }
        
        body {
            background: #f5f5f5;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        .navbar {
            background: linear-gradient(135deg, var(--azure-blue), var(--azure-dark));
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .sidebar {
            background: white;
            height: calc(100vh - 56px);
            position: fixed;
            left: 0;
            top: 56px;
            width: 250px;
            box-shadow: 2px 0 10px rgba(0,0,0,0.05);
            overflow-y: auto;
        }
        
        .sidebar .nav-link {
            color: #333;
            padding: 12px 20px;
            margin: 5px 10px;
            border-radius: 8px;
            transition: all 0.3s;
        }
        
        .sidebar .nav-link:hover, .sidebar .nav-link.active {
            background: var(--azure-blue);
            color: white;
        }
        
        .main-content {
            margin-left: 250px;
            padding: 20px;
        }
        
        .stat-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            transition: transform 0.3s, box-shadow 0.3s;
        }
        
        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 4px 15px rgba(0,0,0,0.15);
        }
        
        .stat-card .icon {
            width: 50px;
            height: 50px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
        }
        
        .card {
            border: none;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }
        
        .ticket-card {
            cursor: pointer;
            transition: all 0.3s;
            border-left: 4px solid var(--azure-blue);
        }
        
        .ticket-card:hover {
            transform: translateX(5px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        
        .btn-azure {
            background: var(--azure-blue);
            color: white;
            border: none;
        }
        
        .btn-azure:hover {
            background: var(--azure-dark);
            color: white;
        }
        
        .test-table {
            width: 100%;
            background: white;
        }
        
        .test-table thead {
            background: var(--azure-blue);
            color: white;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        
        .test-table th {
            padding: 12px 8px;
            font-weight: 600;
            border: 1px solid #dee2e6;
        }
        
        .test-table td {
            padding: 8px;
            border: 1px solid #dee2e6;
            vertical-align: middle;
        }
        
        .test-table tbody tr:hover {
            background: #f8f9fa;
        }
        
        .test-table input, .test-table select, .test-table textarea {
            width: 100%;
            border: 1px solid #ced4da;
            padding: 4px 8px;
            border-radius: 4px;
        }
        
        .test-table textarea {
            min-height: 60px;
            resize: vertical;
        }
        
        .status-badge {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 600;
            display: inline-block;
            width: 100%;
            text-align: center;
        }
        
        .status-passed { background: #d4edda; color: #155724; }
        .status-failed { background: #f8d7da; color: #721c24; }
        .status-pending { background: #fff3cd; color: #856404; }
        .status-blocked { background: #d1ecf1; color: #0c5460; }
        
        .table-container {
            max-height: 500px;
            overflow-y: auto;
            border: 1px solid #dee2e6;
            border-radius: 8px;
        }
        
        .env-column {
            min-width: 120px;
        }
        
        .ticket-header {
            background: linear-gradient(135deg, var(--azure-blue), var(--azure-dark));
            color: white;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 20px;
        }
        
        .analytics-box {
            background: white;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
        }
        
        .chart-container {
            position: relative;
            height: 250px;
        }
        
        .action-btn {
            padding: 4px 8px;
            font-size: 12px;
            margin: 2px;
        }
        
        .modal-xl {
            max-width: 95%;
        }
        
        @media print {
            .sidebar, .navbar, .no-print {
                display: none !important;
            }
            .main-content {
                margin-left: 0;
            }
        }
    </style>
</head>
<body>
    <!-- Navbar -->
    <nav class="navbar navbar-expand-lg navbar-dark">
        <div class="container-fluid">
            <a class="navbar-brand" href="#">
                <i class="fab fa-microsoft"></i> Test Case Manager
            </a>
            <div class="ms-auto">
                <button class="btn btn-light btn-sm me-2" onclick="showSettings()">
                    <i class="fas fa-cog"></i> Settings
                </button>
                <button class="btn btn-success btn-sm me-2" onclick="showImportModal()">
                    <i class="fas fa-file-import"></i> Import
                </button>
                <button class="btn btn-warning btn-sm" onclick="exportAllData()">
                    <i class="fas fa-file-export"></i> Export All
                </button>
            </div>
        </div>
    </nav>

    <!-- Sidebar -->
    <div class="sidebar">
        <ul class="nav flex-column">
            <li class="nav-item">
                <a class="nav-link active" href="#" onclick="showSection('dashboard')">
                    <i class="fas fa-home me-2"></i> Dashboard
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="#" onclick="showSection('tickets')">
                    <i class="fas fa-ticket-alt me-2"></i> Tickets
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="#" onclick="showSection('reports')">
                    <i class="fas fa-chart-line me-2"></i> Reports & Analytics
                </a>
            </li>
        </ul>
    </div>

    <!-- Main Content -->
    <div class="main-content">
        <!-- Dashboard Section -->
        <div id="dashboard-section" class="content-section">
            <h2 class="mb-4"><i class="fas fa-home"></i> Dashboard</h2>
            
            <div class="row mb-4">
                <div class="col-md-3">
                    <div class="stat-card">
                        <div class="d-flex align-items-center">
                            <div class="icon bg-primary bg-opacity-10 text-primary">
                                <i class="fas fa-ticket-alt"></i>
                            </div>
                            <div class="ms-3">
                                <h6 class="text-muted mb-0">Total Tickets</h6>
                                <h3 class="mb-0" id="stat-total-tickets">0</h3>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="stat-card">
                        <div class="d-flex align-items-center">
                            <div class="icon bg-success bg-opacity-10 text-success">
                                <i class="fas fa-check-circle"></i>
                            </div>
                            <div class="ms-3">
                                <h6 class="text-muted mb-0">Total Test Cases</h6>
                                <h3 class="mb-0" id="stat-total-tests">0</h3>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="stat-card">
                        <div class="d-flex align-items-center">
                            <div class="icon bg-danger bg-opacity-10 text-danger">
                                <i class="fas fa-times-circle"></i>
                            </div>
                            <div class="ms-3">
                                <h6 class="text-muted mb-0">Failed Tests</h6>
                                <h3 class="mb-0" id="stat-failed">0</h3>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="stat-card">
                        <div class="d-flex align-items-center">
                            <div class="icon bg-warning bg-opacity-10 text-warning">
                                <i class="fas fa-percentage"></i>
                            </div>
                            <div class="ms-3">
                                <h6 class="text-muted mb-0">Pass Rate</h6>
                                <h3 class="mb-0" id="stat-pass-rate">0%</h3>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="row">
                <div class="col-md-12">
                    <div class="card">
                        <div class="card-body">
                            <h5 class="card-title">Recent Tickets</h5>
                            <div id="recent-tickets"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tickets Section -->
        <div id="tickets-section" class="content-section" style="display: none;">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2><i class="fas fa-ticket-alt"></i> Tickets</h2>
                <button class="btn btn-azure" onclick="showAddTicketModal()">
                    <i class="fas fa-plus"></i> Add Ticket
                </button>
            </div>
            
            <div id="tickets-list"></div>
        </div>

        <!-- Reports Section -->
        <div id="reports-section" class="content-section" style="display: none;">
            <h2 class="mb-4"><i class="fas fa-chart-line"></i> Reports & Analytics</h2>
            
            <div class="row">
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-body">
                            <h5 class="card-title">Test Status Distribution</h5>
                            <div class="chart-container">
                                <canvas id="statusChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-body">
                            <h5 class="card-title">Environment Pass Rates</h5>
                            <div class="chart-container">
                                <canvas id="envChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="row mt-4">
                <div class="col-md-12">
                    <div class="card">
                        <div class="card-body">
                            <h5 class="card-title">Detailed Report</h5>
                            <button class="btn btn-success btn-sm mb-3" onclick="exportReportCSV()">
                                <i class="fas fa-file-csv"></i> Export Report
                            </button>
                            <div id="detailed-report"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Ticket Modal -->
    <div class="modal fade" id="addTicketModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title">Add New Ticket</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="ticketForm">
                        <div class="mb-3">
                            <label class="form-label">Ticket ID <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="ticketId" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Ticket Name (Optional)</label>
                            <input type="text" class="form-control" id="ticketName">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Description (Optional)</label>
                            <textarea class="form-control" id="ticketDesc" rows="3"></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-azure" onclick="saveTicket()">Save Ticket</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Ticket Details Modal -->
    <div class="modal fade" id="ticketDetailsModal" tabindex="-1">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title" id="ticketDetailsTitle"></h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div id="ticketDetailsContent"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div class="modal fade" id="settingsModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title"><i class="fas fa-cog"></i> Environment Settings</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p><strong>Configure your test environments:</strong></p>
                    <div id="environmentsList"></div>
                    <button class="btn btn-success btn-sm mt-3" onclick="addEnvironment()">
                        <i class="fas fa-plus"></i> Add Environment
                    </button>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-azure" onclick="saveEnvironments()">Save Changes</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Import Modal -->
    <div class="modal fade" id="importModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-success text-white">
                    <h5 class="modal-title"><i class="fas fa-file-import"></i> Import Test Cases</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Select Ticket</label>
                        <select class="form-select" id="importTicketSelect">
                            <option value="">Choose a ticket...</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Upload CSV File</label>
                        <input type="file" class="form-control" id="csvFileInput" accept=".csv">
                        <small class="text-muted">CSV Format: Test Case Name, Steps, Expected Result, Environment1 Status, Environment2 Status...</small>
                    </div>
                    <div class="alert alert-info">
                        <strong>CSV Example:</strong><br>
                        <code>Test Case Name,Steps,Expected Result,Staging,Production<br>
                        Login Test,Enter credentials,User logged in,passed,pending</code>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-success" onclick="importCSV()">Import</button>
                </div>
            </div>
        </div>
    </div>

    <!-- jQuery -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        // Data Storage
        let tickets = [];
        let testCases = [];
        let environments = ['Staging', 'Production'];
        let charts = {};
        let currentTicketId = null;

        // Initialize
        $(document).ready(function() {
            loadData();
            updateDashboard();
            renderTickets();
            initCharts();
        });

        // Section Navigation
        function showSection(section) {
            $('.content-section').hide();
            $(`#${section}-section`).show();
            $('.sidebar .nav-link').removeClass('active');
            $(`.sidebar .nav-link[onclick="showSection('${section}')"]`).addClass('active');
            
            if (section === 'dashboard') {
                updateDashboard();
            } else if (section === 'reports') {
                updateReports();
            }
        }

        // Show Add Ticket Modal
        function showAddTicketModal() {
            $('#ticketForm')[0].reset();
            $('#addTicketModal').modal('show');
        }

        // Save Ticket
        function saveTicket() {
            const ticketId = $('#ticketId').val().trim();
            const ticketName = $('#ticketName').val().trim();
            const ticketDesc = $('#ticketDesc').val().trim();

            if (!ticketId) {
                alert('Ticket ID is required!');
                return;
            }

            const ticket = {
                id: ticketId,
                name: ticketName || ticketId,
                description: ticketDesc,
                createdAt: new Date().toISOString()
            };

            tickets.push(ticket);
            saveData();
            
            $('#addTicketModal').modal('hide');
            renderTickets();
            updateDashboard();
            showNotification('Ticket created successfully!', 'success');
        }

        // Delete Ticket
        function deleteTicket(ticketId) {
            if (!confirm('Are you sure you want to delete this ticket and all its test cases?')) {
                return;
            }
            
            tickets = tickets.filter(t => t.id !== ticketId);
            testCases = testCases.filter(tc => tc.ticketId !== ticketId);
            saveData();
            
            renderTickets();
            updateDashboard();
            showNotification('Ticket deleted successfully!', 'success');
        }

        // Render Tickets
        function renderTickets() {
            const container = $('#tickets-list');
            container.empty();

            if (tickets.length === 0) {
                container.html('<div class="text-center text-muted py-5"><i class="fas fa-inbox fa-3x mb-3"></i><p>No tickets yet. Create your first ticket!</p></div>');
                return;
            }

            tickets.forEach(ticket => {
                const ticketTests = testCases.filter(tc => tc.ticketId === ticket.id);
                
                const card = $(`
                    <div class="card ticket-card mb-3">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-start">
                                <div class="flex-grow-1" onclick="showTicketDetails('${ticket.id}')" style="cursor: pointer;">
                                    <h5 class="card-title mb-2">
                                        <i class="fas fa-ticket-alt text-primary"></i> ${ticket.id}
                                    </h5>
                                    ${ticket.name !== ticket.id ? `<h6 class="text-muted">${ticket.name}</h6>` : ''}
                                    ${ticket.description ? `<p class="card-text">${ticket.description}</p>` : ''}
                                    <span class="badge bg-primary">${ticketTests.length} Test Cases</span>
                                </div>
                                <div>
                                    <button class="btn btn-sm btn-outline-primary me-1" onclick="showTicketDetails('${ticket.id}')">
                                        <i class="fas fa-eye"></i> View
                                    </button>
                                    <button class="btn btn-sm btn-outline-danger" onclick="deleteTicket('${ticket.id}')">
                                        <i class="fas fa-trash"></i> Delete
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                `);
                container.append(card);
            });
        }

        // Show Ticket Details
        function showTicketDetails(ticketId) {
            currentTicketId = ticketId;
            const ticket = tickets.find(t => t.id === ticketId);
            const ticketTests = testCases.filter(tc => tc.ticketId === ticketId);

            $('#ticketDetailsTitle').html(`<i class="fas fa-ticket-alt"></i> ${ticket.id} - ${ticket.name}`);
            
            // Calculate statistics for each environment
            let envStats = {};
            environments.forEach(env => {
                const passed = ticketTests.filter(tc => tc.environments && tc.environments[env] === 'passed').length;
                const failed = ticketTests.filter(tc => tc.environments && tc.environments[env] === 'failed').length;
                const pending = ticketTests.filter(tc => tc.environments && tc.environments[env] === 'pending').length;
                const blocked = ticketTests.filter(tc => tc.environments && tc.environments[env] === 'blocked').length;
                
                envStats[env] = { passed, failed, pending, blocked, total: ticketTests.length };
            });

            let content = `
                <!-- Ticket Header -->
                <div class="ticket-header">
                    <div class="row">
                        <div class="col-md-8">
                            <h4><i class="fas fa-ticket-alt"></i> ${ticket.id}</h4>
                            <h5>${ticket.name}</h5>
                            <p class="mb-0">${ticket.description || 'No description'}</p>
                            <small><i class="far fa-calendar"></i> Created: ${new Date(ticket.createdAt).toLocaleString()}</small>
                        </div>
                        <div class="col-md-4 text-end">
                            <h2 class="mb-0">${ticketTests.length}</h2>
                            <p class="mb-0">Total Test Cases</p>
                        </div>
                    </div>
                </div>

                <!-- Analytics -->
                <div class="row mb-3">
            `;

            // Environment analytics
            environments.forEach(env => {
                const stats = envStats[env];
                const passRate = stats.total > 0 ? Math.round((stats.passed / stats.total) * 100) : 0;
                
                content += `
                    <div class="col-md-${12/environments.length}">
                        <div class="analytics-box">
                            <h6><i class="fas fa-server"></i> ${env}</h6>
                            <div class="progress mb-2" style="height: 25px;">
                                <div class="progress-bar bg-success" style="width: ${stats.total ? (stats.passed/stats.total*100) : 0}%" title="Passed">${stats.passed}</div>
                                <div class="progress-bar bg-danger" style="width: ${stats.total ? (stats.failed/stats.total*100) : 0}%" title="Failed">${stats.failed}</div>
                                <div class="progress-bar bg-warning" style="width: ${stats.total ? (stats.pending/stats.total*100) : 0}%" title="Pending">${stats.pending}</div>
                                <div class="progress-bar bg-info" style="width: ${stats.total ? (stats.blocked/stats.total*100) : 0}%" title="Blocked">${stats.blocked}</div>
                            </div>
                            <small>
                                <span class="badge bg-success">${stats.passed}</span>
                                <span class="badge bg-danger">${stats.failed}</span>
                                <span class="badge bg-warning text-dark">${stats.pending}</span>
                                <span class="badge bg-info">${stats.blocked}</span>
                                <span class="badge bg-secondary">${passRate}% Pass</span>
                            </small>
                        </div>
                    </div>
                `;
            });

            content += `
                </div>

                <!-- Action Buttons -->
                <div class="mb-3">
                    <button class="btn btn-primary btn-sm" onclick="addNewRow()">
                        <i class="fas fa-plus"></i> Add Test Case
                    </button>
                    <button class="btn btn-success btn-sm" onclick="showImportModalForTicket('${ticketId}')">
                        <i class="fas fa-file-import"></i> Import CSV
                    </button>
                    <button class="btn btn-warning btn-sm" onclick="exportTicketCSV('${ticketId}')">
                        <i class="fas fa-file-export"></i> Export CSV
                    </button>
                    <button class="btn btn-info btn-sm" onclick="saveAllTests()">
                        <i class="fas fa-save"></i> Save All Changes
                    </button>
                </div>

                <!-- Test Cases Table -->
                <div class="table-container">
                    <table class="test-table table table-bordered table-hover">
                        <thead>
                            <tr>
                                <th style="width: 50px;">#</th>
                                <th style="width: 250px;">Test Case Name</th>
                                <th style="width: 300px;">Test Steps</th>
                                <th style="width: 200px;">Expected Result</th>
            `;

            // Add environment columns
            environments.forEach(env => {
                content += `<th class="env-column">${env}</th>`;
            });

            content += `
                                <th style="width: 100px;">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="testTableBody">
            `;

            // Add existing test cases
            ticketTests.forEach((tc, index) => {
                content += createTestRow(tc, index + 1);
            });

            content += `
                        </tbody>
                    </table>
                </div>
            `;

            $('#ticketDetailsContent').html(content);
            $('#ticketDetailsModal').modal('show');
        }

        // Create Test Row
        function createTestRow(testCase, rowNum) {
            const tcId = testCase ? testCase.id : Date.now() + Math.random();
            let row = `
                <tr data-test-id="${tcId}">
                    <td class="text-center">${rowNum}</td>
                    <td><input type="text" class="test-name" value="${testCase ? testCase.name : ''}" placeholder="Enter test case name"></td>
                    <td><textarea class="test-steps" placeholder="Enter test steps">${testCase ? testCase.steps : ''}</textarea></td>
                    <td><textarea class="test-expected" placeholder="Enter expected result">${testCase ? testCase.expectedResult : ''}</textarea></td>
            `;

            environments.forEach(env => {
                const status = testCase && testCase.environments ? testCase.environments[env] : 'pending';
                row += `
                    <td>
                        <select class="env-status" data-env="${env}">
                            <option value="pending" ${status === 'pending' ? 'selected' : ''}>Pending</option>
                            <option value="passed" ${status === 'passed' ? 'selected' : ''}>Passed</option>
                            <option value="failed" ${status === 'failed' ? 'selected' : ''}>Failed</option>
                            <option value="blocked" ${status === 'blocked' ? 'selected' : ''}>Blocked</option>
                        </select>
                    </td>
                `;
            });

            row += `
                    <td class="text-center">
                        <button class="btn btn-danger btn-sm action-btn" onclick="deleteTestRow(this)">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                </tr>
            `;

            return row;
        }

        // Add New Row
        function addNewRow() {
            const tbody = $('#testTableBody');
            const rowCount = tbody.find('tr').length;
            tbody.append(createTestRow(null, rowCount + 1));
            showNotification('New test case row added', 'info');
        }

        // Delete Test Row
        function deleteTestRow(btn) {
            if (!confirm('Delete this test case?')) return;
            
            const row = $(btn).closest('tr');
            const testId = row.data('test-id');
            
            // Remove from array
            testCases = testCases.filter(tc => tc.id !== testId);
            
            // Remove row
            row.remove();
            
            // Renumber rows
            $('#testTableBody tr').each(function(index) {
                $(this).find('td:first').text(index + 1);
            });
            
            saveData();
            showNotification('Test case deleted', 'success');
        }

        // Save All Tests
        function saveAllTests() {
            if (!currentTicketId) return;

            const rows = $('#testTableBody tr');
            const updatedTests = [];

            rows.each(function() {
                const row = $(this);
                const testId = row.data('test-id');
                const name = row.find('.test-name').val().trim();
                
                if (!name) return; // Skip empty rows

                const steps = row.find('.test-steps').val().trim();
                const expectedResult = row.find('.test-expected').val().trim();
                
                const environments_data = {};
                row.find('.env-status').each(function() {
                    const env = $(this).data('env');
                    const status = $(this).val();
                    environments_data[env] = status;
                });

                // Check if test exists
                let existingTest = testCases.find(tc => tc.id === testId);
                
                if (existingTest) {
                    existingTest.name = name;
                    existingTest.steps = steps;
                    existingTest.expectedResult = expectedResult;
                    existingTest.environments = environments_data;
                    existingTest.updatedAt = new Date().toISOString();
                } else {
                    const newTest = {
                        id: testId,
                        ticketId: currentTicketId,
                        name: name,
                        steps: steps,
                        expectedResult: expectedResult,
                        environments: environments_data,
                        createdAt: new Date().toISOString()
                    };
                    testCases.push(newTest);
                }
            });

            saveData();
            updateDashboard();
            showNotification('All test cases saved successfully!', 'success');
        }

        // Settings
        function showSettings() {
            renderEnvironmentsList();
            $('#settingsModal').modal('show');
        }

        function renderEnvironmentsList() {
            const container = $('#environmentsList');
            container.empty();

            environments.forEach((env, index) => {
                container.append(`
                    <div class="input-group mb-2">
                        <input type="text" class="form-control env-input" value="${env}" data-index="${index}">
                        <button class="btn btn-outline-danger" onclick="removeEnvironment(${index})">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                `);
            });
        }

        function addEnvironment() {
            const envName = prompt('Enter environment name:');
            if (envName && envName.trim()) {
                environments.push(envName.trim());
                renderEnvironmentsList();
            }
        }

        function removeEnvironment(index) {
            if (environments.length <= 1) {
                alert('You must have at least one environment!');
                return;
            }
            if (confirm('Remove this environment? All test data for this environment will be lost.')) {
                environments.splice(index, 1);
                renderEnvironmentsList();
            }
        }

        function saveEnvironments() {
            const newEnvs = [];
            $('.env-input').each(function() {
                const val = $(this).val().trim();
                if (val) newEnvs.push(val);
            });
            
            if (newEnvs.length === 0) {
                alert('You must have at least one environment!');
                return;
            }
            
            environments = newEnvs;
            saveData();
            $('#settingsModal').modal('hide');
            showNotification('Environment settings saved!', 'success');
        }

        // Import/Export
        function showImportModal() {
            updateImportTicketSelect();
            $('#importModal').modal('show');
        }

        function showImportModalForTicket(ticketId) {
            $('#ticketDetailsModal').modal('hide');
            setTimeout(() => {
                updateImportTicketSelect();
                $('#importTicketSelect').val(ticketId);
                $('#importModal').modal('show');
            }, 300);
        }

        function updateImportTicketSelect() {
            const select = $('#importTicketSelect');
            select.empty();
            select.append('<option value="">Choose a ticket...</option>');
            tickets.forEach(ticket => {
                select.append(`<option value="${ticket.id}">${ticket.id} - ${ticket.name}</option>`);
            });
        }

        function importCSV() {
            const ticketId = $('#importTicketSelect').val();
            const fileInput = $('#csvFileInput')[0];
            
            if (!ticketId) {
                alert('Please select a ticket!');
                return;
            }
            
            if (!fileInput.files.length) {
                alert('Please select a CSV file!');
                return;
            }

            const file = fileInput.files[0];
            const reader = new FileReader();
            
            reader.onload = function(e) {
                const text = e.target.result;
                const lines = text.split('\n');
                
                if (lines.length < 2) {
                    alert('CSV file is empty or invalid!');
                    return;
                }
                
                // Parse header
                const headers = lines[0].split(',').map(h => h.trim());
                
                // Find environment columns (after first 3 columns)
                const envColumns = headers.slice(3);
                
                let imported = 0;
                
                // Parse data rows
                for (let i = 1; i < lines.length; i++) {
                    const line = lines[i].trim();
                    if (!line) continue;
                    
                    const values = line.split(',').map(v => v.trim());
                    if (values.length < 3) continue;
                    
                    const name = values[0];
                    const steps = values[1];
                    const expectedResult = values[2];
                    
                    if (!name) continue;
                    
                    const envData = {};
                    envColumns.forEach((envName, index) => {
                        const status = values[3 + index] || 'pending';
                        envData[envName] = status.toLowerCase();
                    });
                    
                    const testCase = {
                        id: Date.now() + Math.random(),
                        ticketId: ticketId,
                        name: name,
                        steps: steps,
                        expectedResult: expectedResult,
                        environments: envData,
                        createdAt: new Date().toISOString()
                    };
                    
                    testCases.push(testCase);
                    imported++;
                }
                
                saveData();
                $('#importModal').modal('hide');
                showNotification(`Successfully imported ${imported} test cases!`, 'success');
                
                if (currentTicketId === ticketId) {
                    showTicketDetails(ticketId);
                }
                
                updateDashboard();
            };
            
            reader.readAsText(file);
        }

        function exportTicketCSV(ticketId) {
            const ticket = tickets.find(t => t.id === ticketId);
            const ticketTests = testCases.filter(tc => tc.ticketId === ticketId);
            
            if (ticketTests.length === 0) {
                alert('No test cases to export!');
                return;
            }
            
            let csv = 'Test Case Name,Steps,Expected Result,' + environments.join(',') + '\n';
            
            ticketTests.forEach(tc => {
                const name = `"${tc.name.replace(/"/g, '""')}"`;
                const steps = `"${tc.steps.replace(/"/g, '""')}"`;
                const expected = `"${tc.expectedResult.replace(/"/g, '""')}"`;
                
                const envStatuses = environments.map(env => tc.environments[env] || 'pending').join(',');
                
                csv += `${name},${steps},${expected},${envStatuses}\n`;
            });
            
            downloadCSV(csv, `${ticket.id}_test_cases.csv`);
            showNotification('Test cases exported!', 'success');
        }

        function exportAllData() {
            if (testCases.length === 0) {
                alert('No test cases to export!');
                return;
            }
            
            let csv = 'Ticket ID,Ticket Name,Test Case Name,Steps,Expected Result,' + environments.join(',') + '\n';
            
            testCases.forEach(tc => {
                const ticket = tickets.find(t => t.id === tc.ticketId);
                const ticketId = `"${ticket.id}"`;
                const ticketName = `"${ticket.name.replace(/"/g, '""')}"`;
                const name = `"${tc.name.replace(/"/g, '""')}"`;
                const steps = `"${tc.steps.replace(/"/g, '""')}"`;
                const expected = `"${tc.expectedResult.replace(/"/g, '""')}"`;
                
                const envStatuses = environments.map(env => tc.environments[env] || 'pending').join(',');
                
                csv += `${ticketId},${ticketName},${name},${steps},${expected},${envStatuses}\n`;
            });
            
            downloadCSV(csv, `all_test_cases_${new Date().toISOString().split('T')[0]}.csv`);
            showNotification('All data exported!', 'success');
        }

        function exportReportCSV() {
            let csv = 'Ticket ID,Ticket Name,Total Tests,';
            
            environments.forEach(env => {
                csv += `${env} Passed,${env} Failed,${env} Pass Rate,`;
            });
            csv += '\n';
            
            tickets.forEach(ticket => {
                const ticketTests = testCases.filter(tc => tc.ticketId === ticket.id);
                let row = `"${ticket.id}","${ticket.name}",${ticketTests.length},`;
                
                environments.forEach(env => {
                    const passed = ticketTests.filter(tc => tc.environments && tc.environments[env] === 'passed').length;
                    const failed = ticketTests.filter(tc => tc.environments && tc.environments[env] === 'failed').length;
                    const passRate = ticketTests.length > 0 ? Math.round((passed / ticketTests.length) * 100) : 0;
                    row += `${passed},${failed},${passRate}%,`;
                });
                
                csv += row + '\n';
            });
            
            downloadCSV(csv, `test_report_${new Date().toISOString().split('T')[0]}.csv`);
            showNotification('Report exported!', 'success');
        }

        function downloadCSV(content, filename) {
            const blob = new Blob([content], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', filename);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // Dashboard
        function updateDashboard() {
            if (!Array.isArray(tickets)) tickets = [];
            if (!Array.isArray(testCases)) testCases = [];
            
            $('#stat-total-tickets').text(tickets.length);
            $('#stat-total-tests').text(testCases.length);
            
            let totalPassed = 0;
            let totalTests = 0;
            
            testCases.forEach(tc => {
                environments.forEach(env => {
                    totalTests++;
                    if (tc.environments && tc.environments[env] === 'passed') {
                        totalPassed++;
                    }
                });
            });
            
            const failedTests = testCases.filter(tc => {
                return environments.some(env => tc.environments && tc.environments[env] === 'failed');
            }).length;
            
            const passRate = totalTests > 0 ? Math.round((totalPassed / totalTests) * 100) : 0;
            
            $('#stat-failed').text(failedTests);
            $('#stat-pass-rate').text(passRate + '%');
            
            // Recent tickets
            const recentHtml = tickets.slice(-5).reverse().map(ticket => {
                const testCount = testCases.filter(tc => tc.ticketId === ticket.id).length;
                return `
                    <div class="d-flex justify-content-between align-items-center mb-2 p-2 border-bottom">
                        <div>
                            <strong>${ticket.id}</strong> - ${ticket.name}
                            <br><small class="text-muted">${testCount} test cases</small>
                        </div>
                        <button class="btn btn-sm btn-primary" onclick="showTicketDetails('${ticket.id}')">View</button>
                    </div>
                `;
            }).join('');
            
            $('#recent-tickets').html(recentHtml || '<p class="text-muted">No tickets yet</p>');
        }

        // Charts
        function initCharts() {
            const statusCtx = document.getElementById('statusChart');
            charts.statusChart = new Chart(statusCtx, {
                type: 'doughnut',
                data: {
                    labels: ['Passed', 'Failed', 'Pending', 'Blocked'],
                    datasets: [{
                        data: [0, 0, 0, 0],
                        backgroundColor: ['#107c10', '#e81123', '#ffb900', '#0078d4']
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false
                }
            });

            const envCtx = document.getElementById('envChart');
            charts.envChart = new Chart(envCtx, {
                type: 'bar',
                data: {
                    labels: environments,
                    datasets: [{
                        label: 'Pass Rate %',
                        data: [],
                        backgroundColor: '#0078d4'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: { max: 100, beginAtZero: true }
                    }
                }
            });
        }

        function updateReports() {
            if (!Array.isArray(testCases)) testCases = [];
            
            // Status distribution
            let passed = 0, failed = 0, pending = 0, blocked = 0;
            
            testCases.forEach(tc => {
                environments.forEach(env => {
                    const status = tc.environments ? tc.environments[env] : 'pending';
                    if (status === 'passed') passed++;
                    else if (status === 'failed') failed++;
                    else if (status === 'blocked') blocked++;
                    else pending++;
                });
            });
            
            charts.statusChart.data.datasets[0].data = [passed, failed, pending, blocked];
            charts.statusChart.update();
            
            // Environment pass rates
            const envPassRates = environments.map(env => {
                const envTests = testCases.filter(tc => tc.environments && tc.environments[env]);
                const envPassed = envTests.filter(tc => tc.environments[env] === 'passed').length;
                return envTests.length > 0 ? Math.round((envPassed / envTests.length) * 100) : 0;
            });
            
            charts.envChart.data.labels = environments;
            charts.envChart.data.datasets[0].data = envPassRates;
            charts.envChart.update();
            
            // Detailed report
            let reportHtml = `
                <div class="table-responsive">
                    <table class="table table-striped table-bordered">
                        <thead class="table-primary">
                            <tr>
                                <th>Ticket ID</th>
                                <th>Ticket Name</th>
                                <th>Total Tests</th>
            `;
            
            environments.forEach(env => {
                reportHtml += `<th>${env} Pass Rate</th>`;
            });
            
            reportHtml += `</tr></thead><tbody>`;
            
            tickets.forEach(ticket => {
                const ticketTests = testCases.filter(tc => tc.ticketId === ticket.id);
                reportHtml += `<tr>
                    <td>${ticket.id}</td>
                    <td>${ticket.name}</td>
                    <td>${ticketTests.length}</td>
                `;
                
                environments.forEach(env => {
                    const passed = ticketTests.filter(tc => tc.environments && tc.environments[env] === 'passed').length;
                    const rate = ticketTests.length > 0 ? Math.round((passed / ticketTests.length) * 100) : 0;
                    const badgeClass = rate >= 80 ? 'bg-success' : rate >= 50 ? 'bg-warning' : 'bg-danger';
                    reportHtml += `<td><span class="badge ${badgeClass}">${rate}%</span></td>`;
                });
                
                reportHtml += `</tr>`;
            });
            
            reportHtml += `</tbody></table></div>`;
            
            $('#detailed-report').html(reportHtml);
        }

        // Notifications
        function showNotification(message, type) {
            const toast = $(`
                <div class="position-fixed top-0 end-0 p-3" style="z-index: 9999">
                    <div class="toast show" role="alert">
                        <div class="toast-header bg-${type} text-white">
                            <strong class="me-auto">Notification</strong>
                            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="toast"></button>
                        </div>
                        <div class="toast-body">${message}</div>
                    </div>
                </div>
            `);
            $('body').append(toast);
            setTimeout(() => toast.remove(), 3000);
        }

        // Storage
        function saveData() {
            try {
                if (!Array.isArray(tickets)) tickets = [];
                if (!Array.isArray(testCases)) testCases = [];
                if (!Array.isArray(environments)) environments = ['Staging', 'Production'];
                
                localStorage.setItem('azureTickets', JSON.stringify(tickets));
                localStorage.setItem('azureTestCases', JSON.stringify(testCases));
                localStorage.setItem('azureEnvironments', JSON.stringify(environments));
            } catch (error) {
                console.error('Error saving data:', error);
            }
        }

        function loadData() {
            try {
                const savedTickets = localStorage.getItem('azureTickets');
                const savedTestCases = localStorage.getItem('azureTestCases');
                const savedEnvironments = localStorage.getItem('azureEnvironments');
                
                if (savedTickets && savedTickets !== 'undefined') {
                    tickets = JSON.parse(savedTickets);
                    if (!Array.isArray(tickets)) tickets = [];
                } else {
                    tickets = [];
                }
                
                if (savedTestCases && savedTestCases !== 'undefined') {
                    testCases = JSON.parse(savedTestCases);
                    if (!Array.isArray(testCases)) testCases = [];
                } else {
                    testCases = [];
                }
                
                if (savedEnvironments && savedEnvironments !== 'undefined') {
                    environments = JSON.parse(savedEnvironments);
                    if (!Array.isArray(environments) || environments.length === 0) {
                        environments = ['Staging', 'Production'];
                    }
                } else {
                    environments = ['Staging', 'Production'];
                }
            } catch (error) {
                console.error('Error loading data:', error);
                tickets = [];
                testCases = [];
                environments = ['Staging', 'Production'];
            }
        }
    </script>
</body>
</html>
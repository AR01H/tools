<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Personal Data Manager - Secure</title>

<!-- Bootstrap + jQuery + Font Awesome + CryptoJS -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">
<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>

<style>
body { background: #f8f9fa; }
.sidebar {
  width: 250px; height: 100vh; background: #343a40; color: #fff; position: fixed; overflow-y: auto;
  transition: width 0.3s ease;
}
.sidebar.collapsed { width: 60px; }
.sidebar h5 { text-align: center; margin: 1rem 0; }
.sidebar button { width: 90%; margin: 0.5rem auto; display: block; }
.sidebar a {
  color: #adb5bd; text-decoration: none; display: block; padding: 8px 20px; border-radius: 5px;
}
.sidebar a:hover, .sidebar a.active { background: #495057; color: #fff; }
.sidebar.collapsed a span { display: none; }
.sidebar.collapsed h5 { display: none; }
.content { margin-left: 270px; padding: 20px; transition: margin-left 0.3s ease; }
.sidebar.collapsed + .content { margin-left: 80px; }
.table td, .table th { vertical-align: middle; }
.copy-btn { cursor: pointer; color: #0d6efd; }
</style>
</head>

<body>
<div class="sidebar" id="sidebar">
  <h5>üìÅ My Folders</h5>
  <div id="folderList"></div>
  <button class="btn btn-outline-light btn-sm" id="newFolder"><i class="fa fa-folder-plus"></i> <span>New Folder</span></button>
  <button class="btn btn-outline-light btn-sm" id="toggleSidebar"><i class="fa fa-bars"></i> <span>Toggle</span></button>
</div>

<div class="content">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h3 id="folderTitle">No Folder Selected</h3>
    <div>
      <button class="btn btn-secondary btn-sm" id="exportNormal"><i class="fa fa-download"></i> Export</button>
      <button class="btn btn-warning btn-sm" id="exportEncrypted"><i class="fa fa-lock"></i> Export Encrypted</button>
      <label class="btn btn-outline-secondary btn-sm mb-0">
        <i class="fa fa-upload"></i> Import <input type="file" id="importNormal" hidden accept=".json">
      </label>
      <label class="btn btn-outline-warning btn-sm mb-0">
        <i class="fa fa-lock"></i> Import Encrypted <input type="file" id="importEncrypted" hidden accept=".json">
      </label>
      <button class="btn btn-primary btn-sm" id="addItem"><i class="fa fa-plus"></i> Add</button>
    </div>
  </div>

  <table class="table table-striped table-bordered">
    <thead class="table-light">
      <tr>
        <th>Title</th>
        <th>Value</th>
        <th>Tags</th>
        <th>Updated</th>
        <th style="width:140px;">Actions</th>
      </tr>
    </thead>
    <tbody id="itemTable"></tbody>
  </table>

  <div id="formSection" class="mt-3 d-none">
    <h5 id="formTitle">Add Item</h5>
    <form id="itemForm" class="card p-3">
      <input type="hidden" name="index">
      <div class="row">
        <div class="col-md-3 mb-2">
          <input type="text" name="title" class="form-control" placeholder="Title" required>
        </div>
        <div class="col-md-4 mb-2">
          <input type="text" name="value" class="form-control" placeholder="Value" required>
        </div>
        <div class="col-md-3 mb-2">
          <input type="text" name="tags" class="form-control" placeholder="Tags">
        </div>
        <div class="col-md-2 mb-2">
          <button class="btn btn-success w-100" type="submit"><i class="fa fa-save"></i> Save</button>
        </div>
      </div>
    </form>
  </div>
</div>

<script>
let data = JSON.parse(localStorage.getItem("foldersData")) || {};
let currentFolder = null;

function saveData() {
  localStorage.setItem("foldersData", JSON.stringify(data));
}

function renderFolders() {
  $("#folderList").empty();
  Object.keys(data).forEach(f => {
    $("#folderList").append(`<a href="#" data-folder="${f}" class="${f===currentFolder?'active':''}"><i class="fa fa-folder me-2"></i><span>${f}</span></a>`);
  });
}

function renderItems() {
  let table = $("#itemTable");
  table.empty();
  if (!currentFolder) return;
  let items = data[currentFolder] || [];
  if (items.length === 0) {
    table.append(`<tr><td colspan="5" class="text-center text-muted">No items found</td></tr>`);
    return;
  }
  items.forEach((it, i) => {
    table.append(`
      <tr>
        <td>${it.title}</td>
        <td>${it.value}</td>
        <td>${it.tags}</td>
        <td>${it.updated}</td>
        <td>
          <span class="copy-btn me-2" onclick="copyText('${it.value}')"><i class="fa fa-copy"></i></span>
          <button class="btn btn-sm btn-outline-dark" onclick="editItem(${i})"><i class="fa fa-pen"></i></button>
          <button class="btn btn-sm btn-danger" onclick="deleteItem(${i})"><i class="fa fa-trash"></i></button>
        </td>
      </tr>
    `);
  });
}

function addFolder(name){ if(!name) return; store.folders.push({id:uid(),name}); save(); renderFolders(); }

function addItem(){ const folderId = (activeFolder==='all' && store.folders[0]) ? store.folders[0].id : activeFolder; const it = { id: uid(), folderId: folderId||(store.folders[0] && store.folders[0].id) || 'all', title:'New item', value:'', tags:'', updated: new Date().toISOString(), pinned:false }; store.items.push(it); save(); renderList(); openEditorInline(it.id); }

function openEditorInline(id){ // close others (option 1)
  closeInline(); openRow = id; const tr = $(`tr[data-id='${id}']`);
  const item = store.items.find(x=>x.id===id);
  const editorRow = $(`<tr class='inline-editor-row'><td colspan='6'><div class='inline-editor'>
    <div class='row g-2'>
      <div class='col-md-4'><input class='form-control edit-title' value='${esc(item.title)}'></div>
      <div class='col-md-4'><input class='form-control edit-tags' value='${esc(item.tags)}' placeholder='comma separated'></div>
      <div class='col-md-4 d-flex align-items-center gap-2'>
        <button class='btn btn-sm btn-outline-secondary btn-expand-value'>Expand Value</button>
        <button class='btn btn-sm btn-outline-secondary btn-toggle-ck' >Use CKEditor</button>
        <div class='form-check ms-auto'><input class='form-check-input form-check-sm edit-pin' type='checkbox' ${item.pinned?'checked':''}> <label class='form-check-label small-muted'>Pin</label></div>
      </div>
      <div class='col-12'><textarea class='form-control edit-value' rows='4' placeholder='Value'>${esc(item.value)}</textarea></div>
      <div class='col-12 text-end'>
        <button class='btn btn-sm btn-success btn-save-inline'>Save</button>
        <button class='btn btn-sm btn-outline-secondary btn-cancel-inline'>Cancel</button>
      </div>
    </div>
  </div></td></tr>`);
  tr.after(editorRow);

  // CKEditor toggle
  let ckInstance = null;
  function enableCK(){
    const ta = editorRow.find('.edit-value');
    CKEDITOR.replace(ta[0]);
    ckInstance = CKEDITOR.instances[ta.attr('id')] || CKEDITOR.instances[Object.keys(CKEDITOR.instances)[0]];
  }
  function disableCK(){
    if(ckInstance){
      ckInstance.updateElement();
      ckInstance.destroy();
      ckInstance=null;
    }
  }
  editorRow.find('.btn-toggle-ck').on('click', function(){
    if(!ckInstance){ enableCK(); $(this).text('Back to Textarea'); }
    else{ disableCK(); $(this).text('Use CKEditor'); }
  });



  editorRow.find('.edit-title, .edit-tags, .edit-value').on('input', function(){
    const it = store.items.find(x=>x.id===id);
    it.title = editorRow.find('.edit-title').val();
    it.tags  = editorRow.find('.edit-tags').val();
    it.value = editorRow.find('.edit-value').val();
    it.updated = new Date().toISOString();
    save(); renderList(); // re-render keeps editor closed normally; to keep open we need to re-open
    // re-open at same id
    setTimeout(()=>{ openEditorInline(id); }, 0);
  });

  // expand value: show full value below editor
  editorRow.find('.btn-expand-value').on('click', function(){
    const full = editorRow.find('.edit-value').val();
    if(editorRow.find('.expanded-value').length){ editorRow.find('.expanded-value').remove(); return; }
    editorRow.find('.edit-value').after(`<div class='expanded-value mt-2'>${esc(full)}</div>`);
  });

  editorRow.find('.btn-save-inline').on('click', function(){
    disableCK();
    const it = store.items.find(x=>x.id===id);
    it.title = editorRow.find('.edit-title').val();
    it.tags  = editorRow.find('.edit-tags').val();
    it.value = editorRow.find('.edit-value').val();
    it.pinned = !!editorRow.find('.edit-pin').is(':checked');
    it.updated = new Date().toISOString();
    save(); renderList(); closeInline();
  });

  editorRow.find('.btn-cancel-inline').on('click', function(){ closeInline(); });
}

function closeInline(){ $('.inline-editor-row').remove(); openRow = null; }

function duplicateItem(id){ const it = store.items.find(x=>x.id===id); if(!it) return; const copy = {...it, id: uid(), title: it.title + ' (copy)', updated: new Date().toISOString()}; store.items.push(copy); save(); renderList(); }

function pinItem(id){ const it = store.items.find(x=>x.id===id); if(!it) return; it.pinned = !it.pinned; it.updated = new Date().toISOString(); save(); renderList(); }

function copyEsc(id){ const it = store.items.find(x=>x.id===id); navigator.clipboard.writeText(it.value||''); }

function deleteItem(id){ if(!confirm('Delete item?')) return; store.items = store.items.filter(x=>x.id!==id); save(); renderList(); }

// Drag & drop reorder
let dragSrc = null;
$(document).on('dragstart','tr[data-id]', function(e){ dragSrc = $(this).data('id'); $(this).addClass('dragging'); e.originalEvent.dataTransfer.effectAllowed = 'move'; });
$(document).on('dragend','tr[data-id]', function(){ $('tr.dragging').removeClass('dragging'); dragSrc=null; });
$(document).on('dragover','tr[data-id]', function(e){ e.preventDefault(); $(this).addClass('drag-over'); });
$(document).on('dragleave','tr[data-id]', function(){ $(this).removeClass('drag-over'); });
$(document).on('drop','tr[data-id]', function(e){ e.preventDefault(); $(this).removeClass('drag-over'); const target = $(this).data('id'); if(!dragSrc || dragSrc===target) return; // reorder in store: move dragSrc before target
  const items = store.items;
  const srcIdx = items.findIndex(x=>x.id===dragSrc); const tgtIdx = items.findIndex(x=>x.id===target);
  if(srcIdx<0||tgtIdx<0) return;
  const [moved] = items.splice(srcIdx,1);
  items.splice(tgtIdx,0,moved);
  save(); renderList(); });

// click handlers
$(function(){ load(); renderFolders(); renderList();
  // folder add
  $('#btnShowAddFolder').on('click', ()=>$('#folderAddBox').toggle());
  $('#btnAddFolder').on('click', ()=>{ const v=$('#folderName').val().trim(); if(v){ addFolder(v); $('#folderName').val(''); $('#folderAddBox').hide(); }});

  $('#folders').on('click','.folder-item', function(){ activeFolder = $(this).data('id'); $('.folder-item').removeClass('active'); $(this).addClass('active'); renderList(); });

  $('#btnAddItem').on('click', addItem);

  $('#list').on('click', '.btn-settings', function(){ const id=$(this).closest('tr').data('id'); openEditorInline(id); });
  $('#list').on('click', '.btn-dup', function(){ const id=$(this).closest('tr').data('id'); duplicateItem(id); });
  $('#list').on('click', '.btn-pin', function(){ const id=$(this).closest('tr').data('id'); pinItem(id); });
  $('#list').on('click', '.btn-copy', function(){ const id=$(this).closest('tr').data('id'); copyEsc(id); });
  $('#list').on('click', '.btn-del', function(){ const id=$(this).closest('tr').data('id'); deleteItem(id); });

  // search
  $('#search').on('input', renderList);

  // export
  $('#btnExport').on('click', ()=>{
    const blob = new Blob([JSON.stringify(store,null,2)],{type:'application/json'}); const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='info-storage.json'; a.click(); URL.revokeObjectURL(url);
  });

  // import controls
  $('#btnDoImport').on('click', ()=>{ doImport(); });
  $('#importFile').on('change', function(e){ const f = this.files[0]; if(!f) return; const r=new FileReader(); r.onload = ev => { try{ const obj=JSON.parse(ev.target.result); processImport(obj); alert('File imported'); }catch(err){ alert('Invalid JSON file'); } }; r.readAsText(f); this.value=''; });
  $('#importPaste').on('keydown', function(e){ if(e.ctrlKey && e.key==='Enter'){ try{ const obj=JSON.parse($(this).val()); processImport(obj); $(this).val(''); alert('Imported from paste'); }catch(err){ alert('Invalid JSON'); } } });

  // expand value on cell click
  $('#list').on('click','.value-cell', function(){ const id = $(this).closest('tr').data('id'); const item = store.items.find(x=>x.id===id); const existing = $(this).find('.expanded-value'); if(existing.length){ existing.remove(); return; } $(this).append('<div class="expanded-value mt-2">'+esc(item.value)+'</div>'); });

  // dark mode toggle
  $('#btnToggleDark').on('click', ()=>{ dark = !dark; if(dark) $('body').addClass('dark-mode'); else $('body').removeClass('dark-mode'); });

  // double click row to quick edit
  $('#list').on('dblclick','tr[data-id]', function(){ const id=$(this).data('id'); openEditorInline(id); });
});

function processImport(obj){ const mode = $('#importMode').val(); if(mode==='replace'){ store = obj; if(!store.folders) store.folders = [{id:'all',name:'All'}]; if(!store.items) store.items = []; save(); renderFolders(); renderList(); return; }
  // add mode: append with new ids if missing
  if(obj.folders && Array.isArray(obj.folders)){
    obj.folders.forEach(f=>{ if(!f.id) f.id=uid(); store.folders.push(f); });
  }
  if(obj.items && Array.isArray(obj.items)){
    obj.items.forEach(it=>{ if(!it.id) it.id = uid(); store.items.push(it); });
  }
  save(); renderFolders(); renderList(); }

function doImport(){ const pasted = $('#importPaste').val().trim(); if(pasted){ try{ const obj = JSON.parse(pasted); processImport(obj); $('#importPaste').val(''); alert('Imported'); }catch(e){ alert('Invalid JSON'); } } else {
  // check file input handled separately
  alert('Please choose a file or paste JSON into the import box.'); }
}
</script>
</body>
</html>

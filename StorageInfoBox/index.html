<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Personal Data Manager - Secure</title>

<!-- Bootstrap + jQuery + Font Awesome + CryptoJS -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">
<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>

<style>
body { background: #f8f9fa; }
.sidebar {
  width: 250px; height: 100vh; background: #343a40; color: #fff; position: fixed; overflow-y: auto;
  transition: width 0.3s ease;
}
.sidebar.collapsed { width: 60px; }
.sidebar h5 { text-align: center; margin: 1rem 0; }
.sidebar button { width: 90%; margin: 0.5rem auto; display: block; }
.sidebar a {
  color: #adb5bd; text-decoration: none; display: block; padding: 8px 20px; border-radius: 5px;
}
.sidebar a:hover, .sidebar a.active { background: #495057; color: #fff; }
.sidebar.collapsed a span { display: none; }
.sidebar.collapsed h5 { display: none; }
.content { margin-left: 270px; padding: 20px; transition: margin-left 0.3s ease; }
.sidebar.collapsed + .content { margin-left: 80px; }
.table td, .table th { vertical-align: middle; }
.copy-btn { cursor: pointer; color: #0d6efd; }
</style>
</head>

<body>
<div class="sidebar" id="sidebar">
  <h5>üìÅ My Folders</h5>
  <div id="folderList"></div>
  <button class="btn btn-outline-light btn-sm" id="newFolder"><i class="fa fa-folder-plus"></i> <span>New Folder</span></button>
  <button class="btn btn-outline-light btn-sm" id="toggleSidebar"><i class="fa fa-bars"></i> <span>Toggle</span></button>
</div>

<div class="content">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h3 id="folderTitle">No Folder Selected</h3>
    <div>
      <button class="btn btn-secondary btn-sm" id="exportNormal"><i class="fa fa-download"></i> Export</button>
      <button class="btn btn-warning btn-sm" id="exportEncrypted"><i class="fa fa-lock"></i> Export Encrypted</button>
      <label class="btn btn-outline-secondary btn-sm mb-0">
        <i class="fa fa-upload"></i> Import <input type="file" id="importNormal" hidden accept=".json">
      </label>
      <label class="btn btn-outline-warning btn-sm mb-0">
        <i class="fa fa-lock"></i> Import Encrypted <input type="file" id="importEncrypted" hidden accept=".json">
      </label>
      <button class="btn btn-primary btn-sm" id="addItem"><i class="fa fa-plus"></i> Add</button>
    </div>
  </div>

  <table class="table table-striped table-bordered">
    <thead class="table-light">
      <tr>
        <th>Title</th>
        <th>Value</th>
        <th>Tags</th>
        <th>Updated</th>
        <th style="width:140px;">Actions</th>
      </tr>
    </thead>
    <tbody id="itemTable"></tbody>
  </table>

  <div id="formSection" class="mt-3 d-none">
    <h5 id="formTitle">Add Item</h5>
    <form id="itemForm" class="card p-3">
      <input type="hidden" name="index">
      <div class="row">
        <div class="col-md-3 mb-2">
          <input type="text" name="title" class="form-control" placeholder="Title" required>
        </div>
        <div class="col-md-4 mb-2">
          <input type="text" name="value" class="form-control" placeholder="Value" required>
        </div>
        <div class="col-md-3 mb-2">
          <input type="text" name="tags" class="form-control" placeholder="Tags">
        </div>
        <div class="col-md-2 mb-2">
          <button class="btn btn-success w-100" type="submit"><i class="fa fa-save"></i> Save</button>
        </div>
      </div>
    </form>
  </div>
</div>

<script>
let data = JSON.parse(localStorage.getItem("foldersData")) || {};
let currentFolder = null;

function saveData() {
  localStorage.setItem("foldersData", JSON.stringify(data));
}

function renderFolders() {
  $("#folderList").empty();
  Object.keys(data).forEach(f => {
    $("#folderList").append(`<a href="#" data-folder="${f}" class="${f===currentFolder?'active':''}"><i class="fa fa-folder me-2"></i><span>${f}</span></a>`);
  });
}

function renderItems() {
  let table = $("#itemTable");
  table.empty();
  if (!currentFolder) return;
  let items = data[currentFolder] || [];
  if (items.length === 0) {
    table.append(`<tr><td colspan="5" class="text-center text-muted">No items found</td></tr>`);
    return;
  }
  items.forEach((it, i) => {
    table.append(`
      <tr>
        <td>${it.title}</td>
        <td>${it.value}</td>
        <td>${it.tags}</td>
        <td>${it.updated}</td>
        <td>
          <span class="copy-btn me-2" onclick="copyText('${it.value}')"><i class="fa fa-copy"></i></span>
          <button class="btn btn-sm btn-outline-dark" onclick="editItem(${i})"><i class="fa fa-pen"></i></button>
          <button class="btn btn-sm btn-danger" onclick="deleteItem(${i})"><i class="fa fa-trash"></i></button>
        </td>
      </tr>
    `);
  });
}

function copyText(text) {
  navigator.clipboard.writeText(text);
  alert("Copied: " + text);
}

$("#toggleSidebar").click(() => {
  $("#sidebar").toggleClass("collapsed");
});

$("#newFolder").click(() => {
  let name = prompt("Enter folder name:");
  if (!name) return;
  if (data[name]) return alert("Folder already exists!");
  data[name] = [];
  currentFolder = name;
  saveData();
  renderFolders();
  renderItems();
  $("#folderTitle").text(name);
});

$(document).on("click", ".sidebar a", function(e){
  e.preventDefault();
  currentFolder = $(this).data("folder");
  $(".sidebar a").removeClass("active");
  $(this).addClass("active");
  $("#folderTitle").text(currentFolder);
  renderItems();
  $("#formSection").addClass("d-none");
});

$("#addItem").click(() => {
  if (!currentFolder) return alert("Select a folder first!");
  $("#formTitle").text("Add Item");
  $("#itemForm")[0].reset();
  $("#itemForm [name=index]").val("");
  $("#formSection").removeClass("d-none");
});

$("#itemForm").submit(function(e){
  e.preventDefault();
  const form = Object.fromEntries(new FormData(this).entries());
  let folder = data[currentFolder];
  const now = new Date().toLocaleString();
  if (form.index) {
    folder[form.index] = { title: form.title, value: form.value, tags: form.tags, updated: now };
  } else {
    folder.push({ title: form.title, value: form.value, tags: form.tags, updated: now });
  }
  saveData();
  renderItems();
  $("#formSection").addClass("d-none");
});

function editItem(i) {
  const it = data[currentFolder][i];
  $("#formTitle").text("Edit Item");
  $("#itemForm [name=title]").val(it.title);
  $("#itemForm [name=value]").val(it.value);
  $("#itemForm [name=tags]").val(it.tags);
  $("#itemForm [name=index]").val(i);
  $("#formSection").removeClass("d-none");
}

function deleteItem(i) {
  if (!confirm("Delete this item?")) return;
  data[currentFolder].splice(i,1);
  saveData();
  renderItems();
}

// EXPORT NORMAL
$("#exportNormal").click(() => {
  const blob = new Blob([JSON.stringify(data, null, 2)], {type: 'application/json'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = "data_export.json";
  a.click();
});

// EXPORT ENCRYPTED
$("#exportEncrypted").click(() => {
  const password = prompt("Enter encryption password:");
  if (!password) return;
  const ciphertext = CryptoJS.AES.encrypt(JSON.stringify(data), password).toString();
  const blob = new Blob([ciphertext], {type: 'application/json'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = "data_encrypted.json";
  a.click();
});

// IMPORT NORMAL
$("#importNormal").change(function(){
  const file = this.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = e => {
    try {
      data = JSON.parse(e.target.result);
      saveData();
      renderFolders();
      renderItems();
      alert("Import successful!");
    } catch {
      alert("Invalid JSON file");
    }
  };
  reader.readAsText(file);
});

// IMPORT ENCRYPTED
$("#importEncrypted").change(function(){
  const file = this.files[0];
  if (!file) return;
  const password = prompt("Enter decryption password:");
  if (!password) return;
  const reader = new FileReader();
  reader.onload = e => {
    try {
      const bytes = CryptoJS.AES.decrypt(e.target.result, password);
      const decrypted = JSON.parse(bytes.toString(CryptoJS.enc.Utf8));
      data = decrypted;
      saveData();
      renderFolders();
      renderItems();
      alert("Decrypted import successful!");
    } catch {
      alert("Invalid password or encrypted file");
    }
  };
  reader.readAsText(file);
});

renderFolders();
renderItems();
</script>
</body>
</html>
